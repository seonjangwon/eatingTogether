<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="/css/layout1.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>[뭐먹을까요:업체] 매장페이지 </title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script>
        const basket_view = (menuNumber) => {
            const view = document.getElementById('modal-body');
            var header = $("meta[name='_csrf_header']").attr('content');
            var token = $("meta[name='_csrf']").attr('content');

            $.ajax({
                type: "get",
                url: '/customer/menu',
                data: {"menuNumber": menuNumber},
                dataType: 'json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (result) {
                    console.log(result);

                    let output = "<div class='row'>" +
                        "<div class='col-3'>" + result.menuExplain + "</div> " +
                        "<div class='col-3'>" + result.menuPrice + "</div> " +
                        "<div class='col-3'><button onclick='menuCountDown()'>-</button>" +
                        "<input type='number' id='menuCount' value='1' readonly>" +
                        "<button onclick='menuCountUp()'>+</button>" +
                        "</div>" +
                        "<button onclick='basketAdd(" + result.menuNumber + ")'>장바구니 담기</button>" +
                        "</div>";
                    view.innerHTML = output;
                },
                error: function () {
                    alert("아작아작");
                }
            });
        }
        const menuCountDown = () => {
            let value = document.getElementById('menuCount');
            let value1 = document.getElementById('menuCount');
            console.log(value);
            if (value.value == 1) {
                alert("더 이상 줄일 수 없습니다")
            } else {
                value1.value = (parseInt(value.value) - 1);
                console.log(value1);
            }
        }
        const menuCountUp = () => {
            let value = document.getElementById('menuCount');
            let value1 = document.getElementById('menuCount');
            console.log(value.value);
            value1.value = (parseInt(value.value) + parseInt("1"));
            console.log(value1.value);
        }
        const basketAdd = (menuNumber) => {
            const value = document.getElementById('menuCount').value; // 메뉴 갯수

            var header = $("meta[name='_csrf_header']").attr('content');
            var token = $("meta[name='_csrf']").attr('content');

            console.log(menuNumber);
            console.log(value);

            $.ajax({
                type: 'post',
                url: '/customer/basket',
                data: {"menuNumber": menuNumber, "menuCount": value},
                dataType: "text",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (result) {
                    console.log(result);
                    if (result === "ok") {
                        alert("장바구니에 담았습니다");
                    } else if (result === "no") {
                        alert("이미 있는 상품입니다")
                    } else if (result === "other") {
                        alert("같은 업체의 메뉴만 담을 수 있습니다")
                    }

                    document.getElementById('modal_close').click();
                },
                error: function () {
                    alert("아작아작아작");
                }
            });
            value.value = 0;
        }
        const wishlist_add_btn = (storeNumber) =>{
            var header = $("meta[name='_csrf_header']").attr('content');
            var token = $("meta[name='_csrf']").attr('content');
            $.ajax({
                type:'post',
                url:'/store/wishList',
                data:{"storeNumber":storeNumber},
                dataType:'text',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success:function (result){
                    if (result === "ok"){
                        alert("찜 등록 완료!")
                    } else if (result === "no"){
                        alert("이미 등록된 업체입니다!")
                    } else {
                        alert("오류!")
                    }
                },
                error:function (){
                    alert("아작아작")
                }
            });
        }
    </script>
</head>
<style>
    a {
        text-decoration-line: none;
    }

    /* 하이퍼링크 꾸밈요소 삭제 */
    a:link {
        color: sandybrown;
    }

    /* 하이퍼링크 관련 */
    a:visited {
        color: sandybrown;
    }

    a:hover {
        color: coral;
    }

    a:active {
        color: deeppink;
    }

    #storeDataView{
        font-family: 'LeeSeoyun';
        border: 0.5px solid;
        border-color: coral;
        border-radius: 0.5rem;
        margin: 5px;
        min-height: 100px;
        max-height: 270px;
        display: grid;
        /*grid-template-columns: 1fr 3fr;*/
        grid-template-rows: 1fr 0.3fr;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    #store{
        margin-bottom: 30px;
    }
    #sAll{
        display: grid;
        grid-template-columns: 1fr 3fr;
    }
    #storeInfo{

    }
    #sInfo{
        font-size: 20px;
    }
    #mrBtn{
        transform: translate(0%,30%);
        height: 40px;
    }

    #menuBtn{
        font-family: 'LeeSeoyun';
        color: blanchedalmond;
        font-weight: bold;
        text-align: center;
        height: 30px;
    }
    #reviewBtn{
        font-family: 'LeeSeoyun';
        color: blanchedalmond;
        font-weight: bold;
        text-align: center;
        height: 30px;
    }
</style><!-- 하이퍼링크용: 수정가능성 있음 -->
<body>
<header>
    <div class="container">
        <div class="row">
            <div class="col-3">
                <span id=logoTitle>
                    <h3><a href="/"> 🍙 뭐먹을까요?</a></h3>
                </span>
            </div>
            <div class="col-2">
                <!-- 공백란 -->
            </div>
            <div class="col-2">
            </div>
            <div class="col-4">
                <span id="menuBar-text">
                     <div th:if="${session.customerLoginEmail == null && session.storeLoginEmail == null}"><!-- 로그인 없음-->
                         뭐먹을까요, eating together!
                     </div>
                    <div th:if="${session.customerLoginEmail}">
                        <a href="/usual/logout"> 로그아웃</a>
                        <a href="/customer/"> 마이페이지</a>
                        <a href="/customer/basket"> 장바구니</a>
                    </div><!-- 회원로그인시 -->

                    <div th:if="${session.storeLoginEmail}">
                        <a href="/usual/logout">로그아웃</a>
                        <a th:href="@{|/store/menuControl/${session['storeLoginEmail']}|}">메뉴관리</a>
                        <a th:href="@{|/store/orderAll/${session['storeLoginEmail']}|}"> 주문관리</a>
                        <a href="/storeMain"> 스토어관리 </a>
                    </div><!-- 업체로그인시 -->
                </span>
            </div>
            <div class="col" id="menuBar-friPan">
                <a href="#" class="btn btn-light btn-sm " tabindex="-1" role="button" aria-disabled="true">🍳</a>
            </div>
        </div>
    </div>
</header><!--header 수정완료-->
<section>
    <div class="container-section-store">
        <form class="row g-3" id="store">
            <div id="storeDataView">
                <div id="sAll">
                    <div id="sImage">
                        <img th:src="@{|/upload/store/${storeList.getStoreFilename()}|}" alt="사진" width="200px" ;
                             height="200px">
                    </div>
                    <div id="sInfo">
                        <h2><span id="storeInfo" th:text="${storeList.storeName}"></span></h2><br>
                        주소:
                        <td th:text="${storeList.storeAddress}"></td>
                        <br>
                        연락처:
                        <td th:text="${storeList.storePhone}"></td>
                        <br>
                        오픈시간:
                        <td th:text="${storeList.storeOpen}"></td>
                        마감시간:
                        <td th:text="${storeList.storeClose}"></td>
                        <br>

                        <button th:onclick="wishlist_add_btn([[${storeList.storeNumber}]])">😘</button>
                        <td th:text="${storeList.storeWish}"></td>
                    </div>
                </div>
                <div id="mrBtn">
                    <a class="btn btn-Light" tabindex="-1" role="button"id="menuBtn" style="background-color: coral" onclick="MenuBtn()" > 메뉴 </a>
                    <a class="btn btn-Light" tabindex="-1" role="button"id="reviewBtn" style="background-color: coral" onclick="reviewBtn()" > 리뷰 </a>
                    <!--<button onclick="MenuBtn()"> 메뉴</button>
                    <button onclick="reviewBtn()"> 리뷰</button>-->
                </div>
            </div>
        </form>

        <div id="menuArea">
            <table class="table table-warning table-hover">
                <thead>
                <th> 사진</th>
                <th> 메뉴</th>
                <th> 설명</th>
                <th> 가격</th>
                <th> 담기 </th> <!-- 주문하는 버튼으로 해야하나요? ?????-->
                </thead>
                <tbody>
                <tr th:each="menu: ${menuList}">
                    <th><img th:src="@{|/upload/store/${menu.menuFilename}|}" alt="사진" width="100px"; height="100px"></th>
                    <td th:text="${menu.menuName}"></td>
                    <td th:text="${menu.menuExplain}"></td>
                    <td th:text="${menu.menuPrice}"></td>
                    <td>
                        <!-- Button trigger modal -->
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal"
                                th:onclick="basket_view([[${menu.menuNumber}]])">
                            장바구니 담기
                        </button>
                    </td>
                    <td th:hidden="${menu.storeNumber}"></td>
                    <td th:hidden="${menu.storeCategoryName}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="reviewArea" style="display: none">
            <table class="table table-warning table-striped">
                <thead>
                <tr>
                    <th>일단 번호</th>
                    <th>매장</th>
                    <th>작성일</th>
                    <th>사진</th>
                    <th>메뉴</th>
                    <th>리뷰 내용</th>
                    <th>사장님 댓글</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r : ${reviewList}">
                    <td th:text="${r.reviewNumber}"></td>
                    <td><a th:href="@{|/store/${r.storeNumber}|}"><p th:text="${r.storeName}"></p></a></td>
                    <td th:text="${r.reviewTime}"></td>
                    <td><!--리뷰 사진-->
                        <table>
                            <thead>
                            <tr>
                                <th>사진</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="menu : ${r.reviewFileDTOList}">
                                <td><img th:src="@{|/upload/review/${menu.reviewFilename}|}" alt=""></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                                <td th:text="${r.menuName}"></td>
                    <td th:text="${r.reviewComments}"></td>
                    <td th:if="${r.replyDetailDTO != null}"><p th:text="${r.replyDetailDTO.replyContents}"></p></td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>
</div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="btn-close" id="modal_close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
<div id="msgStack"></div>
</section>
</body>
<script src="/js/webSocket.js"></script>
<script>

    function MenuBtn() {
        $("#menuArea").show();
        $("#reviewArea").hide();
        console.log("메뉴버튼 클릭");
    }

</script> <!-- 메뉴버튼 클릭 -->
<script>
    const reviewBtn = () => {
        console.log("리뷰버튼 클릭")
        $("#reviewArea").show();
        $("#menuArea").hide();
    };
</script> <!-- 리뷰버튼 클릭-->
</html>